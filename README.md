# deployment-scripts

This repository contains AWS cloud formation scripts to help in generating the infrastructure and services for Deserve Cards.

### How the repository is structured

```
➜  deployment-scripts git:(master) ✗ tree .    # Used tree command line tool to generate this.
.
├── README.md
├── infrastructure                  # Contains infra related cloudformation
│   ├── app-cluster.yml
│   ├── db.yml
│   ├── elasticache.yml
│   ├── iam.yml
│   └── vpc.yml
├── master.cfg.json                 # Contains high level configuration params
├── master.yml                      # Main entry point cloudformation script
├── services                        # Contains project specific services related cloudformation
│   └── service-web.yml
└── useful-shell-scripts            # Contains useful shell scripts
    ├── create-stack.sh
    ├── delete-stack.sh
    ├── sync-s3.sh
    ├── update-stack.sh
    └── validate.sh

```

We have tried to document important areas in the cloud formation scripts (yml) inline. It should help in understanding and maintaining the scripts.

### Prerequisites

* Elastic IP for NAT Gateway - This need to be created before running the master.yml cloudformation script. The Elastic IP should be configured in master.cfg.yml for parameter `NatEIPAllocationId1` ( and `NatEIPAllocationId1` if we need two NAT Gateway). This is not autogenerated because this IP is fixed and shared with third party applications to allow inbound traffic. 

* Cloudformation scripts depends on SSM parameter store for environment specific settings and passwords.

* Postgres database details are fetched from AWS Parameter store. Following need to be available:

* * PG_DATABASE_NAME
* * PG_DATABASE_USER
* * PG_DATABASE_PASSWORD

PG_HOSTNAME will be exported by our cloudformation and stored in parameter store.


#### Issues with handling environment variables

* Currently we have more than 150+ environment variables. As a best practice, we have split them into :
* * Non sensitive 
* * Sensitive (which needs to be kept secure, like passwords, API keys etc)

Sensitive params need to be kept in SSM parameter store and Non sensitive params can be kept under source code itself, for example -- `static/confs/stage/`. 

We have added additional shell scripts in `static` project to inject environment variables from SSM store to application.

```
# New shell scripts which will be used from AWS Fargate tasks

django/start_with_env.sh
django/start_celery_with_env.sh
django/start_manage_py_with_env.sh
django/set_env_variables.sh
django/export_secret_env.py

```
We have also used a small python program `django/export_secret_env.py` to use AWS python SDK to fetch the secured parameters. Without python way of doing this, it needs awscli which needs python 3 etc., All this was complicating the existing application.

We have a small helper shell script to generate aws commands to put parameters into AWS Parameter store `useful-shell-scripts/create-param-store.sh`. This script takes a property file and converts them into AWS command to push them into Parameter store. This is needed only when we have lot of variables to be pushed to Parameter store, else we could create them manually in Parameter store.

### S3 Bucket

Cloud formation scripts are uploaded to S3 bucket.
Name of the S3 bucket used for this -- `cloudformation-deserve-cards-test`

### Creating individual stacks when required
Running `master.yml` will create all the stacks required. If needed we could run individual stacks.

To create IAM roles:
```
aws cloudformation create-stack --template-body file://$PWD/infrastructure/iam.yml --stack-name iam --capabilities CAPABILITY_IAM

```

To create ECS cluster:
```
aws cloudformation create-stack --template-body file://$PWD/infrastructure/app-cluster.yml --stack-name app-cluster

```

### Environment variables

`static` application depends on environment specific settings(configurations). We are planning to manage them using AWS Parameter store and store them as plain string & secureString based on the sensitivity of each variable.

Convention followed for naming the variable in Parameter store

```
<env>/<application>/<variable_name>

example:
stage/service-web/APP_LOG_LEVEL
prod/service-web/APP_LOG_LEVEL
stage/some-other-service/APP_LOG_LEVEL

```

This is maintained under `environment-config` directory.

#### Secure environment variables

AWS doesn't allow creating SecureString from Cloudformation script and it is understandable, since we shouldn't maintain sensitive data in repository. As a helper, we will create such placeholders with following namespace :

```
<env>/<application>/secure/<variable_name>

example:
stage/service-web/secure/CORECARD_PASSWORD --> with placeholder value --> "REQUEST_VALUE".
This need to setup by the admin and update the variable type to *SecureString*

On searching stage/service-web/secure, it should list all such variables that need to be set.


```

#### Development tips

During development, the cloudformation scripts can be run nested as well as individual.
Try to comment out child stack that is currently in development from master.yml. This way, master creates other dependent flows. Create stack with aws console or command line only for the stack that is currently in development. In future, we could come up with validation and automation flows - that would make life much easier.

##### Code suggestions to improve later

* As of now, we see there are 150+ properties.
* * Please remove unused variables
* * Non sensitive environment variables can be handled at service level source code itself, like having separate environment files and picking them based on environment settings. This will bring some ease of use.
* * If we do the above steps., sensitive variables will be a small subset like 10 to 20 variables. Then it will be more meaningful and easier to update them for each environment in AWS. 

### References

We have tried to follow best practices from following open source templates:

* [startup-kit-templates](https://github.com/aws-samples/startup-kit-templates)
* [ecs-refarch-cloudformation](https://github.com/aws-samples/ecs-refarch-cloudformation)

#### Developer tools

* vscode-cfn-lint - This is a useful plugin for Visual studio code to lint (syntax validate) cloud formation scripts.

#### Useful Scripts - Pipeline

```
/deployment-scripts/useful-shell-scripts $ sh sync-s3.sh
/deployment-scripts/useful-shell-scripts $ sh upload-cloudformation-zip.sh

/deployment-scripts/useful-shell-scripts/pipeline$ sh create-pipeline-infra.sh
/deployment-scripts/useful-shell-scripts/pipeline$ sh create-pipeline-task.sh
/deployment-scripts/useful-shell-scripts/pipeline$ sh create-pipeline-web.sh
/deployment-scripts/useful-shell-scripts/pipeline$ sh create-pipeline-worker.sh

/deployment-scripts/useful-shell-scripts$ sh run-task-migrate.sh


```